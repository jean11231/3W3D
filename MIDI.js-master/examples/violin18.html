<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
 <style>

  body {
   background-color: #fff;
   color: #111;
   margin: 0px;
   overflow: hidden;
   font-family: Monospace;
   font-size: 20px;
  }

  #info {
   position: absolute;
   top: 0px;
   width: 100%;
   padding: 5px;
   text-align: center;
   color: #feffee
  }

  a {
   color: #00ffff
  }

  strong {
   color: red
  }

  #container {
   z-index: 0;
   left: 0px;
   top: 0px;
   overflow: hidden;
   position: absolute;
   width: 100%;
   height: 100%;
  }
 </style>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- polyfill -->
 <script src="../inc/shim/Base64.js" type="text/javascript"></script>
 <script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
 <script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
 <!-- midi.js package -->
 <script src="../js/midi/audioDetect.js" type="text/javascript"></script>
 <script src="../js/midi/gm.js" type="text/javascript"></script>
 <script src="../js/midi/loader.js" type="text/javascript"></script>
 <script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
 <script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
 <script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
 <!-- utils -->
 <script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
 <script src="../js/util/dom_request_script.js" type="text/javascript"></script>
</head>

<body>
 <div id="info">
  violin demo
  <br> BPM <input id='tempo' type="range" min=30 max=210 value=60><span id="bpm">60</span><br>

  <br>
  <button id='start1'>Start</button>
  <button id='stop1'>Stop</button>
  <select id='sequence'>
  <option value='ev1' selected> 基本 </option>
  <option value='ev1a'> 基本(漸強) </option>
  <option value='ev1b'> 基本(漸弱) </option>
  <option value='ev2'> 休止符+強弱 </option>
  <option value='ev3b'> 提弓 </option>
  <option value='ev5d'> 換弦 </option>
  
  <option value='ev5f'> 斷奏+連弓 </option>

  <option value='ev6c'> 小練習曲</option>
  <option value='ev13'> 小星星 </option>  
  <option value='ev9'> 9 </option>
  <option value='ev10'> rondo </option>
  <option value='ev11'> green sleeves </option>
</select>

 </div>

 <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.min.js"></script>
 <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
 <script src="https://rawgit.com/mrdoob/three.js/master/examples/js/loaders/MTLLoader.js"></script>
 <script src="https://rawgit.com/mrdoob/three.js/master/examples/js/loaders/OBJLoader.js"></script>

 <script src="test2.js"></script>

 <script>
  var stringAngle = 22;
  var startClick = false;
  //var startClick1 = false;
  var startT;
  var notej = 0;
  var bowP1 = 6.35,
   bowP2 = 6.47;
  var tempP1 = bowP1,
   tempP2 = bowP2;
  var sphereLight;


  class Person {

   makeHumanAndViolin(x,y,z){
    var human = new THREE.Object3D();

    var head = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshLambertMaterial({
    color: 0x666666
    }));
    head.position.set(0, 7, 0);
    var nose = new THREE.Mesh(new THREE.ConeGeometry(0.25, 1, 32), new THREE.MeshLambertMaterial({
    color: 0x666666
    }));
    head.add(nose);
    nose.rotation.x = Math.PI / 2;
    nose.position.set(0, -0.2, 1);
    human.add(head);
    head.rotation.y = Math.PI / 5;

    var body = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 6, 32), new THREE.MeshLambertMaterial({
    color: 0x666666
    }));
    body.position.set(0, 3, 0);
    human.add(body);

    ///////////////////////
    var link1 = makeLink(UPPERARM_LEN);
    link1.position.set(-1.15, 6, 0);

    scene.add(link1);
    var link2 = makeLink(FOREARM_LEN);
    link1.add(link2);
    link2.position.set(3, 0, 0);

    human.add(link1);
    ///////////////////////

    var LeftArm1 = new THREE.Object3D();
    LeftArm1.rotation.x = -Math.PI / 3.1;
    LeftArm1.rotation.y = Math.PI / 18.5;
    LeftArm1.rotation.z = Math.PI / 10;
    LeftArm1.position.set(1.15, 6, 0);
    var lArm1 = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 3, 32), new THREE.MeshLambertMaterial({
    color: 0xffffff
    }));
    LeftArm1.add(lArm1);

    lArm1.position.set(0, -1.5, 0);

    var LeftArm2 = new THREE.Object3D();
    LeftArm2.position.set(0, -3, 0);
    LeftArm2.rotation.x = -Math.PI / 3;

    var lArm2 = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 3, 32), new THREE.MeshLambertMaterial({
    color: 0x666666
    }));
    LeftArm2.add(lArm2);
    LeftArm1.add(LeftArm2);
    lArm2.position.set(0, -1.5, 0);

    human.add(LeftArm1);
    human.position.set(x,y,z);
    scene.add(human);
    //////////////////////////

    var violin = new THREE.Object3D();

    var violin1 = new THREE.Mesh(new THREE.CylinderGeometry(0.89, 0.89, 0.336, 32), new THREE.MeshLambertMaterial({
     color: 0xBB3D00,
     visible: false
    }));
    violin1.position.set(2.67, 0, 0);
    //violin1.material.transparent = true;
    //violin1.material.opacity = 0;
    violin.add(violin1);

    var violin2 = new THREE.Mesh(new THREE.CylinderGeometry(1.04, 1.04, 0.336, 32), new THREE.MeshLambertMaterial({
     color: 0xBB3D00,
     visible: false
    }));
    violin2.position.set(-1.63, 0, 0);
    //violin2.material.transparent = true;
    //violin2.material.opacity = 0;
    violin1.add(violin2);

    var violin3 = new THREE.Mesh(new THREE.CylinderGeometry(0.168, 0.168, 3.56, 32), new THREE.MeshLambertMaterial({
     color: 0x444444,
     visible: false
    }));
    violin3.rotation.z = Math.PI / 2;
    violin3.position.set(1.78, 0, 0);
    //violin3.material.transparent = true;
    //violin3.material.opacity = 0;
    violin1.add(violin3);

    


    ////////////////////////////////////

    var bow3 = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 10, 32), new THREE.MeshLambertMaterial({
     color: 0xffffff,
     visible: false
    }));
    violin1.add(bow3);
    bow3.position.set(-0.79, 0.516, 0.3);

    var bow2 = new THREE.Object3D();
    var bowbow = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 5, 32), new THREE.MeshLambertMaterial({
     color: 0xBB3D00
    }));

    bowbow.position.set(0, -2, 0);
    //bowbow.rotation.y=Math.PI/4;
    bow2.add(bowbow);

    scene.add(bow2);
    scene.add(violin);
    violin.position.set(3.46 - 3.1+x, 6.168+y, 0.5+z);
    violin.rotation.x = Math.PI / 8;
    violin.rotation.y = -Math.PI / 3;
    violin.rotation.z = Math.PI / 10;

    ////////////////////////////////
    tsphere = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({
     wireframe: true
    }));
    scene.add(tsphere);
    ////////////////////////////////
    this.violin = violin;
    this.bow3 = bow3;
    this.bow2 = bow2;
    this.link1 = link1;
    this.link2 = link2;
    this.tsphere = tsphere;
    this.v = 0;
    this.v1 = 0;
    this.vv = 0;
    this.startClick1=false;
    this.startClick2=false;
   }

   CCDsys(){
    this.thetas = [];
    this.axes = [];

    this.target = new THREE.Vector3();

    // FK function set elsewhere
    this.setFK = function(fkEval) {

     this.fk = fkEval;

    }
    this.CCD_axis = function(axis, id, angleLo, angleHi) {

     this.axis = axis.clone();
     this.jointid = id;
     var thetaLo = angleLo === undefined ? 29 : angleLo; // default: no limits
     var thetaHi = angleHi === undefined ? 1e4 : angleHi;
     this.limits = new THREE.Vector2(thetaLo, thetaHi);

    };
    this.update = function() {
     var end = new THREE.Vector3();
     var base = new THREE.Vector3();

     var theta = this.thetas;
     var axes = this.axes;
     var target = this.target;

     var njoints = axes[axes.length - 1].jointid + 1;
     //console.log ('njoints: ' + njoints);
     var joints = [];
     for (var i = 0; i <= njoints; i++) joints[i] = new THREE.Vector3();

     this.fk(theta, joints);
     end.copy(joints[joints.length - 1]);

     // convergence
     var eps = 1e-1;
     var MAXITER = 20;

     var t_target = new THREE.Vector3();
     var t_end = new THREE.Vector3();
     var tmpV = new THREE.Vector3();


     for (var iter = 0; iter < MAXITER; iter++) {
      for (var i = axes.length - 1; i >= 0; i--) {
       base.copy(joints[axes[i].jointid]);


       var axis = axes[i].axis.clone();
       for (var j = i - 1; j >= 0; j--)
        axis.applyMatrix4(new THREE.Matrix4().makeRotationAxis(axes[j].axis, theta[j]));


       tmpV.subVectors(target, base);
       tmpV = proj2plane(tmpV, axis);
       t_target.copy(tmpV.normalize());

       tmpV.subVectors(end, base);
       tmpV = proj2plane(tmpV, axis);
       t_end.copy(tmpV.normalize());

       var dotV = t_end.dot(t_target);
       var angle = Math.acos(CLAMP(dotV, -1, 1));
       tmpV.crossVectors(t_end, t_target);
       var sign = (tmpV.dot(axis) > 0) ? 1 : -1;
       theta[i] += sign * angle;
       if (startClick) axes[i].limits.x = -1e4;
       theta[i] = CLAMP(theta[i], axes[i].limits.x, axes[i].limits.y)

       this.fk(theta, joints);
       end.copy(joints[joints.length - 1]);

       if (end.distanceTo(target) < eps) {
        return 1;
       }
      }

     }

     if (iter < MAXITER)
      return 1;
     else {
      //console.log("do not converge");
      return 0;
     }
    }

    function proj2plane(p, n) {
     return p.clone().projectOnPlane(n);
    }

    function CLAMP(x, xlo, xhi) {
     if (x < xlo)
      return xlo;
     if (x > xhi)
      return xhi;
     return x;
    }

   }

  }
  function makeViolins(){
   var onProgress = function(xhr) {
    if (xhr.lengthComputable) {
     var percentComplete = xhr.loaded / xhr.total * 100;
     console.log(Math.round(percentComplete, 2) + '% downloaded');
    }
   };

   var onError = function(xhr) {};

   //THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());

   var mtlLoader = new THREE.MTLLoader();
   mtlLoader.setPath('violinmesh/');